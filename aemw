#!/usr/bin/env sh

. aem/api.sh

# Download tool

VERSION=${AEMC_VERSION:-"0.5.2"}
COMMAND_DEFAULT=${AEMC_COMMAND_DEFAULT:-"setup"}

OS=$(detectOs)
ARCH=$(detectArch)
DOWNLOAD_URL="https://github.com/wttech/aemc/releases/download/v${VERSION}/aemc-cli_${OS}_${ARCH}.tar.gz"
BIN_ROOT="bin/aemw/$VERSION"
BIN_ARCHIVE_FILE="$BIN_ROOT/aemc-cli.tar.gz"
BIN_ARCHIVE_DIR="$BIN_ROOT/aemc-cli"
BIN_EXEC_FILE="$BIN_ARCHIVE_DIR/aemc-cli"

if [ "$VERSION" = "dev" ]; then
  make build
  BIN_EXEC_FILE="bin/aemc-cli"
elif [ ! -f "$BIN_EXEC_FILE" ]; then
  mkdir -p "$BIN_ARCHIVE_DIR"
  curl -o "$BIN_ARCHIVE_FILE" -OJL "$DOWNLOAD_URL"
  tar -xvf "$BIN_ARCHIVE_FILE" -C "$BIN_ARCHIVE_DIR"
  chmod +x "$BIN_EXEC_FILE"
fi

# shellcheck disable=SC2139
alias aem="./$BIN_EXEC_FILE"

# Include provisioning script that uses API

COMMAND="${1:-$COMMAND_DEFAULT}"
SCRIPT="aem/script/$COMMAND.sh"

if [ -f "$SCRIPT" ]; then
  export AEM_OUTPUT_FORMAT=${AEM_OUTPUT_FORMAT:-none}
  export AEM_INSTANCE_PROCESSING_MODE=${AEM_INSTANCE_PROCESSING_MODE:-parallel}

  STARTED_TIMESTAMP=$(date +%s)
  step "script '$COMMAND' started"
  step "check progress using command 'tail -f aem/home/aem.log'"

  # shellcheck source=aem/*.sh
  . "$SCRIPT"

  ENDED_TIMESTAMP=$(date +%s)
  ELAPSED=$((ENDED_TIMESTAMP - STARTED_TIMESTAMP))
  step "script '$COMMAND' ended in $(duration $ELAPSED)"
else
  aem "$@"
fi
